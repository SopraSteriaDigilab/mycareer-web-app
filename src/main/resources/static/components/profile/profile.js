$(function() {
	populateProfile(getUserName(), getADfullName());
	
	initEmailModal();
	
	//Prevents the menu to collapse when the user clicks on "Print"
	$('#printOption').click(function(event){
	     event.stopPropagation();
	 });
	
	//onClick for opening print modal
	$('.pdf').click(function(event) {
		var id = event.target.id;
		if(id=== "objPDF"){			
			 getObjectivesData();
			 $('#print-modal-title-type').text('Objectives');
		}
		else if(id=== "feedPDF"){
			 getFeedbackData();
			 $('#print-modal-title-type').text('Feedback');
		}
		else if(id=== "devPDF"){
			 getDevelopmentNeedsData();
			 $('#print-modal-title-type').text('Development Needs'); 
		}
		else if(id=== "notesPDF"){
			 getNotesData();
			 $('#print-modal-title-type').text('Notes');
		}
		$("#pdf-modal-body").append("<div class=\"" + id + "\"></div>");
		openPrintModal();
	});
	
	//onClick for closing print modal
	$('#close, #close-print-cross').on('click', function(e) { 
		$('#pdf-modal-body').empty();
		$(".printButton").remove(); //Because the button (automatically generated by Datatables) is appened to .modal-footer each time. 
	});
	
	//onClick for opening email modal
	$('#email').click(function(event) {
		openEmailModal();
	});
	
	//onClick for closing print modal
	$('#close-email , #close-email-x').on('click', function(e) { 
		$('#email-modal').modal('hide');
	});
});

/** Constants */
const NO_EXTRA_EMAIL_ADDRESS = "No extra email address has been written.";

/** DOM element references */
var $sopraSteriaEmails = $(".sopra-steria-emails");
var $addEmailButton = $(".add-email-button");
var $editDeleteEmailButtons = $(".edit-delete-email-buttons");
var $saveCancelEmailButtons = $(".save-cancel-email-buttons");
var $addEmailText = $("#add-email-text");
var $addEmailInput = $("#add-email-input");

var hasExtraEmailAddress = false;
var currentOperation = null;
var currentExtraEmail=getUserAddress();

function populateProfile(userName, fullName){
	$("#userProfileName").append("<h4 class='profile-centre' >" + fullName + " ");
	$("#userProfilePicture").append(getProfilePicture(userName, 48))
							.append("<span class='caret'></span>");
	highlightProfileDropdown("#userProfilePicture, #userProfileName");
}

function highlightProfileDropdown(elements){
    $("#profile-container").hover(function(){
        $(elements).css("color", "#cacaca");
        }, function(){
        $(elements).css("color", "#FFF");
    });
}

//----------------------------------------------------------- print modal ---------------------------------------------------------

//Function to set up and open print modal
function openPrintModal(){
	$('#print-modal').modal(
			{backdrop: 'static', keyboard: false, show: true}
	);
}

//Function to set up and open print modal
function openEmailModal(){
	$('#email-modal').modal(
			{backdrop: 'static', keyboard: false, show: true}
	);
}


//----------------------------------------------------------- email modal ---------------------------------------------------------

/** Initialise the email modal. */
function initEmailModal(){
	getEmails();
	if (hasExtraEmailAddress===false){
		$addEmailButton.show();
		$editDeleteEmailButtons.hide();
		$saveCancelEmailButtons.hide();
	}
	else{
		$addEmailButton.hide();
		$editDeleteEmailButtons.show();
		$saveCancelEmailButtons.hide();
	}
	$("#edit-email-button").click(function(){ editExtraEmail(); });
	$("#delete-email-button").click(function(){ deleteExtraEmail(); });
	$("#save-email-button").click(function(){ saveExtraEmail(); });
	$("#cancel-email-button").click(function(){ closeExtraEmail(); });
	$("#add-email-button").click(function(){ addExtraEmail(); });
}

/** Retrieve email details from database and update relevant DOM Elements. */
function getEmails(){	
	var emailSet=getEmailSet();
	var userAddress=getUserAddress();
	if (!(userAddress === null || userAddress === '')){hasExtraEmailAddress = true};
	setEmailAddresses(emailSet,userAddress); //In success function
}

/** Sets the email addresses in the HTML */
function setEmailAddresses(sopraSteriaEmailAddresses,preferedEmailAddress){
	
	var sopraSteriaEmailsHTML = '<ul><li class="ui-menu-item" role="menuitem">' + sopraSteriaEmailAddresses.join('</li><li>') + '</li></ul>';
	var extraEmail = (preferedEmailAddress == null || preferedEmailAddress == '') ? NO_EXTRA_EMAIL_ADDRESS : preferedEmailAddress;

	$addEmailInput.val(preferedEmailAddress);
	setExtraEmailLabel(extraEmail);
	$sopraSteriaEmails.html(sopraSteriaEmailsHTML);
}

/** Sets extra email label */
function setExtraEmailLabel(extraEmail){
	if (extraEmail!==NO_EXTRA_EMAIL_ADDRESS){
		$addEmailText.text(extraEmail);
	}
	else {
		$addEmailText.text(NO_EXTRA_EMAIL_ADDRESS);
	}
//	var extra = (extraEmail == "") ? NO_EXTRA_EMAIL_ADDRESS : isValidEmailAddress(extraEmail);
	
}

function addToSaveCancel(){
	$addEmailText.hide();
	$addEmailButton.hide();
	$saveCancelEmailButtons.show();
	$addEmailInput.show();
}

function editDeleteToSaveCancel(){
	$editDeleteEmailButtons.hide();
	$addEmailText.hide();
	$saveCancelEmailButtons.show();
	$addEmailInput.show();
}

function saveCancelToEditDelete(){
	$saveCancelEmailButtons.hide();
	$addEmailInput.hide();
	$addEmailText.show();
	$editDeleteEmailButtons.show();	
}

function saveCancelToAdd(){
	$saveCancelEmailButtons.hide();
	$addEmailInput.hide();
	$addEmailText.show();
	$addEmailButton.show();	
}

/** Make extra email address editable. */
function editExtraEmail(){
	currentOperation="edit";
	if ($addEmailText.text() !== NO_EXTRA_EMAIL_ADDRESS){
		$addEmailInput.val($addEmailText.text());
	}
	editDeleteToSaveCancel()
}

function deleteExtraEmail(){
	deleteExtraEmailAction(function(){deleteExtraEmailSuccess()});
}

function deleteExtraEmailSuccess(){
	currentExtraEmail="";
	$addEmailInput.val('');
	$editDeleteEmailButtons.hide();
	$addEmailButton.show();
	$addEmailText.text(NO_EXTRA_EMAIL_ADDRESS);
}

function deleteExtraEmailError(){
}

function addExtraEmail(){
	currentOperation="add";
	addToSaveCancel();
}

function closeExtraEmail(){
	$addEmailInput.val('');
	if (currentOperation==="edit"){
		saveCancelToEditDelete()
	}
	if (currentOperation==="add"){
		saveCancelToAdd();
	}
}

/** Save extra email address to the database. */
function saveExtraEmail(){
	
	var extraEmailInput=$addEmailInput.val();
	var extraEmailText=$addEmailText.text();
	
	if (isExtraEmailUpdated(extraEmailInput)){
		if (extraEmailInput===""){
			currentExtraEmail=extraEmailInput;
			deleteExtraEmail();
			$addEmailText.text(NO_EXTRA_EMAIL_ADDRESS);
			saveCancelToAdd();
		}	
		else{
			var validEmail=isValidEmailAddress(extraEmailInput);	
			if (!validEmail){
				toastr.error("Email format is incorrect");
				return;
			}
			else {
				currentExtraEmail=extraEmailInput;
				saveExtraEmailAction(extraEmailInput, function(extraEmailInput){
					saveExtraEmailSuccess(extraEmailInput)
					}
				);
			}
		}
	}
	else {
		if (extraEmailInput===""){
			$addEmailText.text(NO_EXTRA_EMAIL_ADDRESS);
			saveCancelToAdd();
		}	
		else {
			saveCancelToEditDelete();			
		}
	}
}

function isExtraEmailUpdated(extraEmailInput){
	if(extraEmailInput===currentExtraEmail){
		return false;
	}
	else{
		return true;
	}
}

function saveExtraEmailSuccess(extraEmailInput){
	setExtraEmailLabel(extraEmailInput);
	saveCancelToEditDelete();
}

function saveExtraEmailError(){
}