$(function() {
	populateProfile(getUserName(), getADfullName());
	
	initEmailModal();
	
	//Prevents the menu to collapse when the user clicks on "Print"
	$('#printOption').click(function(event){
	     event.stopPropagation();
	 });
	
	//onClick for opening print modal
	$('.pdf').click(function(event) {
		var id = event.target.id;
		if(id=== "objPDF"){			
			 getObjectivesData();
			 $('#print-modal-title-type').text('Objectives');
		}
		else if(id=== "feedPDF"){
			 getFeedbackData();
			 $('#print-modal-title-type').text('Feedback');
		}
		else if(id=== "devPDF"){
			 getDevelopmentNeedsData();
			 $('#print-modal-title-type').text('Development Needs'); 
		}
		else if(id=== "notesPDF"){
			 getNotesData();
			 $('#print-modal-title-type').text('Notes');
		}
		$("#pdf-modal-body").append("<div class=\"" + id + "\"></div>");
		openPrintModal();
	});
	
	//onClick for closing print modal
	$('#close, #close-print-cross').on('click', function(e) { 
		$('#pdf-modal-body').empty();
		$(".printButton").remove(); //Because the button (automatically generated by Datatables) is appened to .modal-footer each time. 
	});
	
	//onClick for opening email modal
	$('#email').click(function(event) {
		openEmailModal();
	});
	
	//onClick for closing print modal
	$('#close-email , #close-email-x').on('click', function(e) { 
		$('#email-modal').modal('hide');
	});
});

/** Constants */
const NO_EXTRA_EMAIL_ADDRESS = "No extra email address has been written.";

/** DOM element references */
var $sopraSteriaEmails = $(".sopra-steria-emails");
var $addEmailButton = $(".add-email-button");
var $editDeleteEmailButtons = $(".edit-delete-email-buttons");
var $saveCancelEmailButtons = $(".save-cancel-email-buttons");
var $addEmailText = $("#add-email-text");
var $addEmailInput = $("#add-email-input");

var hasExtraEmailAddress = false;
var currentOperation = null;


function populateProfile(userName, fullName){
	$("#userProfileName").append("<h4 class='profile-centre' >" + fullName + " ");
	$("#userProfilePicture").append(getProfilePicture(userName, 48))
							.append("<span class='caret'></span>");
	highlightProfileDropdown("#userProfilePicture, #userProfileName");
}

function highlightProfileDropdown(elements){
    $("#profile-container").hover(function(){
        $(elements).css("color", "#cacaca");
        }, function(){
        $(elements).css("color", "#FFF");
    });
}

//----------------------------------------------------------- print modal ---------------------------------------------------------

//Function to set up and open print modal
function openPrintModal(){
	$('#print-modal').modal(
			{backdrop: 'static', keyboard: false, show: true}
	);
}

//Function to set up and open print modal
function openEmailModal(){
	$('#email-modal').modal(
			{backdrop: 'static', keyboard: false, show: true}
	);
}


//----------------------------------------------------------- email modal ---------------------------------------------------------

/** Initialise the email modal. */
function initEmailModal(){
	getEmails();
	if (hasExtraEmailAddress===false){
		$addEmailButton.show();
		$editDeleteEmailButtons.hide();
		$saveCancelEmailButtons.hide();
	}
	else{
		$addEmailButton.hide();
		$editDeleteEmailButtons.show();
		$saveCancelEmailButtons.hide();
	}
	$("#edit-email-button").click(function(){ editExtraEmail(); });
	$("#delete-email-button").click(function(){ deleteExtraEmail(); });
	$("#save-email-button").click(function(){ saveExtraEmail(); });
	$("#cancel-email-button").click(function(){ closeExtraEmail(); });
	$("#add-email-button").click(function(){ addExtraEmail(); });
}

/** Retrieve email details from database and update relevant DOM Elements. */
function getEmails(){
	console.log("getting emails");
	const data = {
		"sopraSteriaEmailAddresses":["alexandre.brard@soprasteria.com","alexandre.brard2@soprasteria.com"],
//		"preferedEmailAddress":"alexandre.brard@something.else",
		"preferedEmailAddress":"",
	};
	//TODO Ajax Request to get email addresses.
	
	if (data.preferedEmailAddress !== ""){hasExtraEmailAddress = true};
	setEmailAddresses(data.sopraSteriaEmailAddresses,data.preferedEmailAddress); //In success function
}

/** Sets the email addresses in the HTML */
function setEmailAddresses(sopraSteriaEmailAddresses,preferedEmailAddress){
	var sopraSteriaEmails = '<ul><li class="ui-menu-item" role="menuitem">' + sopraSteriaEmailAddresses.join('</li><li>') + '</li></ul>';

	var extraEmail = (preferedEmailAddress == "") ? NO_EXTRA_EMAIL_ADDRESS : preferedEmailAddress;

	$addEmailInput.val(preferedEmailAddress);
	setExtraEmailLabel(extraEmail);
	$sopraSteriaEmails.html(sopraSteriaEmails);
}

/** Sets extra email label */
function setExtraEmailLabel(extraEmail){
	var extra = (extraEmail == "") ? NO_EXTRA_EMAIL_ADDRESS : extraEmail;
	$addEmailText.text(extra);
}


/** Make extra email address editable. */
function editExtraEmail(){
	currentOperation="edit";
	$editDeleteEmailButtons.hide();
	$addEmailText.hide();
	$saveCancelEmailButtons.show();
	$addEmailInput.show();
}

function deleteExtraEmail(){
	$editDeleteEmailButtons.hide();
	$addEmailButton.show();
	$addEmailText.text(NO_EXTRA_EMAIL_ADDRESS);
}

function addExtraEmail(){
	currentOperation="add";
	$addEmailText.hide();
	$addEmailButton.hide();
	$saveCancelEmailButtons.show();
	$addEmailInput.show();
}

function closeExtraEmail(){
	if (currentOperation==="edit"){
		$saveCancelEmailButtons.hide();
		$editDeleteEmailButtons.show();
		$addEmailInput.hide();
		$addEmailText.show();
	}
	if (currentOperation==="add"){
		$saveCancelEmailButtons.hide();
		$addEmailButton.show();
		$addEmailInput.hide();
		$addEmailText.show();
	}
}

/** Save extra email address to the database. */
function saveExtraEmail(){
	console.log("saving my extra email address: " + $addEmailInput.val());
	//TODO Ajax request to save extra email address.
	
	setExtraEmailLabel($addEmailInput.val());
	
	if ($addEmailInput.val()===""){
		$addEmailButton.show()
		$addEmailText.show();
		$saveCancelEmailButtons.hide();
		$addEmailInput.hide();
	}
	else{
		$editDeleteEmailButtons.show();
		$addEmailText.show()
		$saveCancelEmailButtons.hide();
		$addEmailInput.hide();
	}	
}
